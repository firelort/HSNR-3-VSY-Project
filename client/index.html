<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./css/main.css" type="text/css">
</head>
<body>

<div class="login-wrapper">
    <form id="login" class="form-signin" action="">
        <h2>Login</h2>
        <input id="u" autocomplete="off" class="form-control" placeholder="Benutzername" autofocus="autofocus"/>
        <button class="btn">Send</button>
        <p class="login-error">&nbsp;</p>
    </form>
</div>


<div class="sidebar">
    <div class="sidebar-inner">
        <div class="sidebar-logo">
            <span class="title">Lobbies und Spieler</span>
        </div>
        <ul class="sidebar-menu chat-rooms">
            <li>
                <a href="#">
                    Dashboard
                </a>
            </li>
        </ul>
    </div>
</div>


<div class="sidebar-right sidebar chat-content">
    <div class="sidebar-inner">
        <div class="sidebar-logo">
            <span class="title">Chat</span>
        </div>
        <ul class="sidebar-menu" id="messages"></ul>
        <form class="chat-form" action="">
            <input id="m" class="chat-input" autocomplete="off"/>
            <p class="typing"></p>
        </form>
    </div>
</div>

<div class="page-container">
    <header class="header"></header>
    <main class="main-content">


        <div class="game-container">
            <div class="game-opponent-container">

                <table class="player-field">
                    <thead>
                    <th>&nbsp;</th>
                    <th>1</th>
                    <th>2</th>
                    <th>3</th>
                    <th>4</th>
                    <th>5</th>
                    <th>6</th>
                    <th>7</th>
                    <th>8</th>
                    <th>9</th>
                    <th>10</th>
                    </thead>
                    <tbody>
                    <tr>
                        <td>A</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>B</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>C</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>D</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>E</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>F</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>G</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>H</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>I</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>J</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>


            </div>
            <div class="game-player-container">
                <table class="player-field">
                    <thead>
                    <th>&nbsp;</th>
                    <th>1</th>
                    <th>2</th>
                    <th>3</th>
                    <th>4</th>
                    <th>5</th>
                    <th>6</th>
                    <th>7</th>
                    <th>8</th>
                    <th>9</th>
                    <th>10</th>
                    </thead>
                    <tbody>
                    <tr>
                        <td>A</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>B</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>C</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>D</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>E</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>F</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>G</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>H</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>I</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>J</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>
                <div class="player-ships">

                </div>
            </div>
        </div>


    </main>
    <footer class="footer"><span>Alex, Nhan, Marvin, David</span></footer>
</div>

<div class="contextmenu">
    <ul class="options"></ul>
</div>
<div class="contextmenu-background"></div>
<script src="./js/socket.io.js"></script>
<script src="./js/jquery-1.11.1.js"></script>
<script>


   var chatw = class {


        constructor() {
            if (!chatw.instance) {
                chatw.instance = this;
                this.container = $("#messages");
            }
            return chatw.instance;

        }
    };
    const chat = new chatw();
    console.log(chat);


    $(function () {

        function log(eventName, message) {
            if (typeof message == 'object')
                message = JSON.stringify(message);
            var content = eventName + '>' + (message ? message : '');
            console.log(content);
        }

        var donethis = false;

        socket = io.connect('http://localhost', {
            'reconnection': true,
            'reconnectionDelay': 1000,
            'reconnectionDelayMax': 5000,
            'reconnectionAttempts': 1
        });
        socket.on('connect_error', handleNoConnect);
        socket.on('connect_timeout', handleNoConnect);
        socket.on('connect', onConnect);
        socket.on('connect', function () {
            log('connect', 'connected');
        })
            .on('connect_error', function (err) {
                log('connect_error', err);
            })
            .on('connect_timeout', function () {
                log('connect_timeout');
            })
            .on('reconnect', function (attempt) {
                log('reconnect', 'Attempt #' + attempt);
            })
            .on('reconnecting', function (attempt) {
                log('reconnecting', 'Attempt #' + attempt);
            })
            .on('reconnect_attempt', function () {
                log('reconnect_attempt');
                handleNoConnect();
            })
            .on('reconnect_error', function (err) {
                log('reconnect_error', err);
            })
            .on('reconnect_failed', function () {
                log('reconnect_failed');
            })
            .on('news', function (data) {
                log('news', data);
            });

        function handleNoConnect() {
            if (!donethis) {


                delete socket;
                socket = io.connect('http://localhost:3000', {
                    'forceNew': true,
                    'reconnection': true,
                    'reconnectionDelay': 1000,
                    'reconnectionDelayMax': 5000,
                    'reconnectionAttempts': 2
                });
                socket.on('connect_error', handleNoConnect2);
                socket.on('connect_timeout', handleNoConnect2);
                socket.on('connect', onConnect);
                donethis = !donethis;
            }
        }

        function handleNoConnect2() {
            // decide what to do when you can't connect to either
        }

        function onConnect() {
            // set other event handlers on a connected socket
            socket.on('disconnect', function () {

            }).on('chat message', function (msg) {
                if (isLoggedIn) {
                    var item = $('<li>');
                    item.addClass('message');

                    if (msg.type == 'message') {
                        item.html("<b>" + msg.name + "</b>: " + msg.msg);
                    } else if (msg.type == 'event') {
                        item.html("<i>" + msg.msg + "</i>");
                    }

                    $('#messages').append(item);
                }
            }).on('accepted game move', function (data) {

                var item = $('<li>');
                item.addClass('message');

                item.html("<i>" + data.msg + "</i>");
                $('.player-field tr').eq(data.move.row).find('td').eq(data.move.column).addClass('active')

                $('#messages').append(item);

            }).on('set username', function (msg) {
                if (!msg.error) {
                    $('.login-wrapper').hide();
                    isLoggedIn = true;
                    $('.chat-input').focus();
                } else {
                    $('.login-error').text(msg.msg);
                }
            }).on('typing', function (data) {
                if (data) {
                    $('.typing').html(data);
                } else {
                    $('.typing').html("");
                }
            }).on('user update', function (usernames) {

                var userList = [];

                $.each(usernames, function (k, entry) {
                    userList.push("<li><a class='player-link' href='#'>" + k + "</a></li>");

                });

                $(".chat-rooms").html(userList.join(""));


            });
            ;
        }


        var isLoggedIn = false;

        var typingTimeout;

        var hasStartPosition;
        var startPosition;


        function closeContextmenu() {
            $('.contextmenu').hide();
            $('.contextmenu-background').hide();
            $('.contextmenu .options').html('');
        }

        $(document).on('contextmenu', '.player-link', function (e) {


            e.preventDefault();

            var cm = $('.contextmenu').show();
            var cmbg = $('.contextmenu-background').show();

            $(this).addClass('active');
            let etop = ($(this).offset().top);
            let text = $(this).text() + " zum Spiel einladen";
            let template = `<li><a data-player="${$(this).text()}" class="player-invite" href="#">${text}</a></li>`;


            var opt = $('.contextmenu .options');
            cm.css("top", etop + $(this).height());
            opt.append(template);
        }).on('click', '.contextmenu-background', function (e) {

            closeContextmenu();

        }).on('click', '.player-invite', function (e) {
            e.preventDefault();
            socket.emit('invite player', $(this).data('player'));
            closeContextmenu();

        });
        $('#login').submit(function () {
            socket.emit('set username', $('#u').val());
            //$('#m').val('');
            return false;
        });


        $(".game-player-container tbody tr").click(function (e) {

            let row = this.rowIndex;
            let column = e.target.cellIndex;
            if ((row) >= 1 && (row) <= 10 && column >= 1 && column <= 10) {
                positionShip({row: row, column: column});
            }

        });

        function touchesShip(coordinates) {

            let rows = $('.game-player-container .player-field tr');
            return rows.eq(coordinates.row - 1).find('td').eq(coordinates.column).hasClass("active") // top
                || rows.eq(coordinates.row).find('td').eq(coordinates.column + 1).hasClass("active") // right
                || rows.eq(coordinates.row + 1).find('td').eq(coordinates.column).hasClass("active") // bottom
                || rows.eq(coordinates.row).find('td').eq(coordinates.column - 1).hasClass("active") // left
        }

        function isPathAvailable(start, end) {

            let isFree = true;
            let startRow, startColumn, endRow, endColumn;

            if (start.row === end.row && start.column !== end.column) { // horizontal
                startColumn = (start.column > end.column ? end.column : start.column);
                endColumn = (start.column < end.column ? end.column : start.column);
                for (let i = startColumn; i <= endColumn && (isFree); i++) {
                    isFree = !touchesShip({row: start.row, column: i});
                }
            } else if (start.row !== end.row && start.column === end.column) { // senkrecht
                startRow = (start.row > end.row ? end.row : start.row);
                endRow = (start.row < end.row ? end.row : start.row);
                for (let i = startRow; i <= endRow && (isFree); i++) {
                    isFree = !touchesShip({row: i, column: start.column});
                }
            }

            return isFree;
        }


        function setPathActive(start, end) {

            let startRow, startColumn, endRow, endColumn;
            let rows = $('.game-player-container .player-field tr');
            if (start.row === end.row && start.column !== end.column) { // horizontal
                startColumn = (start.column > end.column ? end.column : start.column);
                endColumn = (start.column < end.column ? end.column : start.column);
                for (let i = startColumn; i <= endColumn; i++) {
                    rows.eq(start.row).find('td').eq(i).addClass('active');
                }
            } else if (start.row !== end.row && start.column === end.column) { // senkrecht
                startRow = (start.row > end.row ? end.row : start.row);
                endRow = (start.row < end.row ? end.row : start.row);
                for (let i = startRow; i <= endRow; i++) {
                    rows.eq(i).find('td').eq(start.column).addClass('active');
                }
            }

        }

        function isInLine(start, end) {
            return (start.row === end.row && start.column !== end.column) || (start.column === end.column && start.row !== end.row)

        }

        function positionShip(position) {
            if (touchesShip(position)) {
                let item = $('<li>');
                item.addClass('message');
                item.html("<i>Darf kein anderes SChiff berühren</i>");
                $('#messages').append(item);
            } else {
                let clickedCell = $('.game-player-container .player-field tr').eq(position.row).find('td').eq(position.column);
                if (clickedCell.hasClass('active') || clickedCell.hasClass('highlighted')) {
                    console.log("invalid"); // TODO spieler wissen lassen
                    return false;
                }
                if (!hasStartPosition) {
                    startPosition = position;
                    clickedCell.addClass('highlighted');
                } else {
                    console.log();
                    let startCell = $('.game-player-container .player-field tr').eq(startPosition.row).find('td').eq(startPosition.column)
                    if (isInLine(startPosition, position) && isPathAvailable(startPosition, position)) {
                        setPathActive(startPosition, position);
                    } else {
                        startCell.removeClass('highlighted');
                        let item = $('<li>');
                        item.addClass('message');
                        item.html("<i>Ungültiger Move du Bitch</i>");
                        $('#messages').append(item);
                    }
                }

                hasStartPosition = !hasStartPosition;
            }

        }


        $('.chat-form').submit(function () {
            socket.emit('chat message', {msg: $('#m').val(), timestamp: Date.now()});
            $('#m').val('');
            return false;
        });


        function timeoutFunction() {
            typing = false;
            socket.emit("typing", false);
        }

        $('#m').keypress(function () {
            typing = true;
            socket.emit('typing', 'typing...');
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(timeoutFunction, 500);
        });

    });
</script>
</body>
</html>